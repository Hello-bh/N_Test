<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Wide Area Force Logger (Fixed)</title>
    <style>
        /* í™”ë©´ ê½‰ ì±„ìš°ê¸° ì„¤ì • */
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            text-align: center; color: #333;
            user-select: none; -webkit-touch-callout: none;
        }

        .container {
            display: flex; flex-direction: column; height: 100%; padding: 10px; box-sizing: border-box;
        }
        
        /* ìƒë‹¨: ê°’ í‘œì‹œ */
        .top-panel {
            flex: 0 0 auto; background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px;
        }
        #current-force {
            font-size: 4em; font-weight: 900; color: #222; margin: 0; line-height: 1;
            font-variant-numeric: tabular-nums;
        }
        .status-text { font-size: 0.9em; color: #666; margin-top: 5px; display: flex; justify-content: space-between; padding: 0 10px;}

        /* ì¤‘ë‹¨: í„°ì¹˜ ì˜ì—­ (ìµœëŒ€í™”) */
        #touch-area {
            flex: 1; width: 100%;
            background-color: #e9ecef; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: bold; color: #868e96;
            border: 4px dashed #adb5bd; margin-bottom: 10px;
            touch-action: none; transition: background-color 0.1s;
        }
        #touch-area.active { 
            background-color: #ffc9c9 !important; border-color: #ff6b6b !important; color: #c92a2a !important; 
        }

        /* í•˜ë‹¨: ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .bottom-panel {
            flex: 0 0 auto; background: white; padding: 10px; border-radius: 15px; font-size: 0.9em;
        }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        input[type=number] { padding: 8px; width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        
        button { border: none; border-radius: 8px; padding: 10px; font-weight: bold; font-size: 14px; cursor: pointer; width: 100%; }
        .btn-calib { background-color: #20c997; color: white; width: auto; flex-grow: 1; margin-left: 5px; }
        .btn-download { background-color: #339af0; color: white; margin-top: 5px; padding: 12px; font-size: 16px; }
        button:disabled { background-color: #dee2e6; color: #adb5bd; }
        
        #drag-status.warning { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-panel">
        <div class="status-text">
            <span>Force (N)</span>
            <span id="drag-status">ëŒ€ê¸°ì¤‘</span>
        </div>
        <h1 id="current-force">0.000</h1>
    </div>

    <div id="touch-area">
        <div style="font-size: 2rem;">ğŸ‘‡</div>
        <div style="margin-top:10px;">ì´ ì˜ì—­ ì „ì²´ê°€<br>ì €ìš¸ì…ë‹ˆë‹¤</div>
    </div>

    <div class="bottom-panel">
        <div class="control-row" style="background: #f8f9fa; padding: 8px; border-radius: 8px;">
            <div style="font-weight:bold; margin-right:5px;">âš–ï¸ ë³´ì •:</div>
            <input type="number" id="calib-weight" placeholder="g">
            <span style="margin: 0 5px;">g</span>
            <button class="btn-calib" onclick="calibrate()">ì„¤ì • ì ìš©</button>
        </div>
        <div id="calib-msg" style="font-size: 0.8em; color: green; margin-bottom: 5px;"></div>

        <div style="font-size: 0.8em; color: #555; margin-bottom: 2px;" id="log-count">ë°ì´í„°: 0ê±´</div>
        <button id="download-btn" class="btn-download" disabled>ğŸ“¥ ì—‘ì…€(CSV) ì €ì¥</button>
    </div>
</div>

<script>
    // === ì „ì—­ ë³€ìˆ˜ ===
    const touchArea = document.getElementById('touch-area');
    const forceDisplay = document.getElementById('current-force');
    const dragStatusDisplay = document.getElementById('drag-status');
    const logCountDisplay = document.getElementById('log-count');
    const downloadBtn = document.getElementById('download-btn');
    const calibMsg = document.getElementById('calib-msg');

    const G_TO_N = 0.00980665; 
    let forceFactor = 385 * G_TO_N; 

    // ë°ì´í„° ì €ì¥ì†Œ
    let logData = [];
    let loggingInterval = null;
    let isTouching = false;
    let startTime = 0;

    // ìœ„ì¹˜ ë° ì›€ì§ì„ ê³„ì‚° ë³€ìˆ˜
    let currentRawForce = 0;
    let currentForceN = 0;
    let currentX = 0, currentY = 0;
    
    // [ìˆ˜ì •ë¨] ì§ì „ ë¡œê·¸ ì‹œì ì˜ ìœ„ì¹˜ (ì›€ì§ì„ íŒë³„ìš©)
    let lastLogX = 0, lastLogY = 0;
    let isDragging = false;

    // === ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===

    // 1. í„°ì¹˜ ì‹œì‘
    touchArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (e.touches.length > 0) {
            resetSession();
            isTouching = true;
            touchArea.classList.add('active');
            touchArea.innerHTML = "<div style='font-size:3rem;'>âœŠ</div><div>ì¸¡ì • ì¤‘...</div>";

            // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            lastLogX = currentX;
            lastLogY = currentY;
            isDragging = false;
            
            startTime = Date.now();
            startLogging();
        }
    }, { passive: false });

    // 2. í„°ì¹˜ ì´ë™ (ì¢Œí‘œì™€ ì••ë ¥ë§Œ ì—…ë°ì´íŠ¸, ë“œë˜ê·¸ íŒë³„ì€ setIntervalë¡œ ì´ë™)
    touchArea.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length > 0 && isTouching) {
            const touch = e.touches[0];

            currentRawForce = touch.force || touch.webkitForce || 0;
            currentForceN = (currentRawForce * forceFactor);
            
            currentX = touch.clientX;
            currentY = touch.clientY;
            
            // í™”ë©´ ê°’ ì—…ë°ì´íŠ¸ (ìƒíƒœ í…ìŠ¤íŠ¸ëŠ” setIntervalì—ì„œ ì—…ë°ì´íŠ¸ë¨)
            forceDisplay.innerText = currentForceN.toFixed(3);
        }
    }, { passive: false });

    // 3. í„°ì¹˜ ì¢…ë£Œ
    touchArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopLogging();
        isTouching = false;
        
        currentRawForce = 0;
        currentForceN = 0;
        isDragging = false;
        
        forceDisplay.innerText = "0.000";
        dragStatusDisplay.innerText = "ì¸¡ì • ì™„ë£Œ";
        dragStatusDisplay.classList.remove('warning');
        
        touchArea.classList.remove('active');
        touchArea.innerHTML = "<div style='font-size: 2rem;'>ğŸ‘‡</div><div style='margin-top:10px;'>ë‹¤ì‹œ ëˆ„ë¥´ë©´<br>ì‹œì‘í•©ë‹ˆë‹¤</div>";
        
        if (logData.length > 1) downloadBtn.disabled = false;
    });

    // === ë¡œê¹… ë° ë¡œì§ í•¨ìˆ˜ ===

    function startLogging() {
        if (loggingInterval) clearInterval(loggingInterval);
        
        if(logData.length === 0) {
            logData.push(["Time(s)", "Force(N)", "Raw", "X", "Y", "Is_Moving"]);
        }

        loggingInterval = setInterval(() => {
            if (!isTouching) return;

            // [ìˆ˜ì •ëœ ë¡œì§] ë“œë˜ê·¸ íŒë³„: ì§ì „ ìœ„ì¹˜(lastLogX/Y)ì™€ í˜„ì¬ ìœ„ì¹˜ ë¹„êµ
            // 0.05ì´ˆ ë™ì•ˆ ì´ë™í•œ ê±°ë¦¬ë¥¼ ê³„ì‚°
            const moveDist = Math.sqrt(Math.pow(currentX - lastLogX, 2) + Math.pow(currentY - lastLogY, 2));
            
            // 0.05ì´ˆ ë™ì•ˆ 2í”½ì…€ ì´ìƒ ì›€ì§ì˜€ìœ¼ë©´ ì›€ì§ì´ëŠ” ì¤‘ìœ¼ë¡œ íŒë‹¨ (ë¯¼ê°ë„ ì¡°ì ˆ ê°€ëŠ¥)
            isDragging = moveDist > 2;

            // í˜„ì¬ ìœ„ì¹˜ë¥¼ 'ì§ì „ ìœ„ì¹˜'ë¡œ ê°±ì‹  (ë‹¤ìŒ ë¹„êµë¥¼ ìœ„í•´)
            lastLogX = currentX;
            lastLogY = currentY;

            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            if (isDragging) {
                dragStatusDisplay.innerText = "ì›€ì§ì´ëŠ” ì¤‘ âš ï¸";
                dragStatusDisplay.classList.add('warning');
            } else {
                dragStatusDisplay.innerText = "ê³ ì •ë¨ (ì•ˆì •)";
                dragStatusDisplay.classList.remove('warning');
            }

            // ë°ì´í„° ì €ì¥
            const now = Date.now();
            const timeSec = ((now - startTime) / 1000).toFixed(2);
            
            logData.push([
                timeSec,
                currentForceN.toFixed(4),
                currentRawForce.toFixed(4),
                currentX.toFixed(0),
                currentY.toFixed(0),
                isDragging ? "TRUE" : "FALSE"
            ]);

            logCountDisplay.innerText = `ë°ì´í„°: ${logData.length - 1}ê±´`;
        }, 50); // 50ms ê°„ê²©
    }

    function stopLogging() {
        if (loggingInterval) {
            clearInterval(loggingInterval);
            loggingInterval = null;
        }
    }

    function resetSession() {
        logData = [];
        downloadBtn.disabled = true;
        logCountDisplay.innerText = "ë°ì´í„°: 0ê±´";
        calibMsg.innerText = "";
    }

    function calibrate() {
        const inputWeight = parseFloat(document.getElementById('calib-weight').value);
        if (!inputWeight || inputWeight <= 0) {
            alert("ë¬´ê²Œ(g)ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return;
        }
        if (currentRawForce <= 0.02) {
            alert("í™”ë©´ì„ ëˆ„ë¥¸ ìƒíƒœì—ì„œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."); return;
        }

        const targetN = inputWeight * G_TO_N;
        forceFactor = targetN / currentRawForce;
        
        calibMsg.innerText = `âœ… ë³´ì • ì™„ë£Œ (${inputWeight}g ê¸°ì¤€)`;
        forceDisplay.innerText = (currentRawForce * forceFactor).toFixed(3);
    }

    downloadBtn.addEventListener('click', () => {
        if (logData.length <= 1) return;
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        logData.forEach(row => csvContent += row.join(",") + "\r\n");
        
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        const date = new Date();
        link.setAttribute("download", `Force_${date.getHours()}${date.getMinutes()}${date.getSeconds()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
</script>

</body>
</html>
