<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Wide Area Force Logger</title>
    <style>
        /* í™”ë©´ ê½‰ ì±„ìš°ê¸° ì„¤ì • */
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            text-align: center; color: #333;
            user-select: none; -webkit-touch-callout: none;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒì„ ì„¸ë¡œ ë°©í–¥ Flexë¡œ ì„¤ì • */
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        
        /* 1. ìƒë‹¨: ê°’ í‘œì‹œ ì˜ì—­ (ê³ ì • í¬ê¸°) */
        .top-panel {
            flex: 0 0 auto; /* í¬ê¸° ê³ ì • */
            background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px;
        }
        #current-force {
            font-size: 4em; font-weight: 900; color: #222; margin: 0; line-height: 1;
            font-variant-numeric: tabular-nums;
        }
        .status-text { font-size: 0.9em; color: #666; margin-top: 5px; display: flex; justify-content: space-between; padding: 0 10px;}

        /* 2. ì¤‘ë‹¨: í„°ì¹˜ ì˜ì—­ (ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€) */
        #touch-area {
            flex: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            width: 100%;
            background-color: #e9ecef; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: bold; color: #868e96;
            border: 4px dashed #adb5bd; 
            margin-bottom: 10px;
            touch-action: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ì œìŠ¤ì²˜ ì°¨ë‹¨ */
            transition: background-color 0.1s;
        }
        /* í„°ì¹˜ ì‹œ ìŠ¤íƒ€ì¼ */
        #touch-area.active { 
            background-color: #ffc9c9 !important; 
            border-color: #ff6b6b !important; 
            color: #c92a2a !important; 
        }

        /* 3. í•˜ë‹¨: ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ê³ ì • í¬ê¸°) */
        .bottom-panel {
            flex: 0 0 auto; /* í¬ê¸° ê³ ì • */
            background: white; padding: 10px; border-radius: 15px;
            font-size: 0.9em;
        }
        
        /* ì…ë ¥ì°½ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        input[type=number] { padding: 8px; width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        
        button {
            border: none; border-radius: 8px; padding: 10px; font-weight: bold; font-size: 14px; cursor: pointer; width: 100%;
        }
        .btn-calib { background-color: #20c997; color: white; width: auto; flex-grow: 1; margin-left: 5px; }
        .btn-download { background-color: #339af0; color: white; margin-top: 5px; padding: 12px; font-size: 16px; }
        button:disabled { background-color: #dee2e6; color: #adb5bd; }
        
        #drag-status.warning { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-panel">
        <div class="status-text">
            <span>Force (N)</span>
            <span id="drag-status">ëŒ€ê¸°ì¤‘</span>
        </div>
        <h1 id="current-force">0.000</h1>
    </div>

    <div id="touch-area">
        <div style="font-size: 2rem;">ğŸ‘‡</div>
        <div style="margin-top:10px;">ì´ ì˜ì—­ ì „ì²´ê°€<br>ì €ìš¸ì…ë‹ˆë‹¤</div>
    </div>

    <div class="bottom-panel">
        <div class="control-row" style="background: #f8f9fa; padding: 8px; border-radius: 8px;">
            <div style="font-weight:bold; margin-right:5px;">âš–ï¸ ë³´ì •:</div>
            <input type="number" id="calib-weight" placeholder="g">
            <span style="margin: 0 5px;">g</span>
            <button class="btn-calib" onclick="calibrate()">ì„¤ì • ì ìš©</button>
        </div>
        <div id="calib-msg" style="font-size: 0.8em; color: green; margin-bottom: 5px;"></div>

        <div style="font-size: 0.8em; color: #555; margin-bottom: 2px;" id="log-count">ë°ì´í„°: 0ê±´</div>
        <button id="download-btn" class="btn-download" disabled>ğŸ“¥ ì—‘ì…€(CSV) ì €ì¥</button>
    </div>
</div>

<script>
    // === ì „ì—­ ë³€ìˆ˜ ===
    const touchArea = document.getElementById('touch-area');
    const forceDisplay = document.getElementById('current-force');
    const dragStatusDisplay = document.getElementById('drag-status');
    const logCountDisplay = document.getElementById('log-count');
    const downloadBtn = document.getElementById('download-btn');
    const calibMsg = document.getElementById('calib-msg');

    // ê¸°ë³¸ ë³´ì •ê°’ (iPhone ê¸°ë³¸ê°’ ê°€ì •)
    const G_TO_N = 0.00980665; 
    let forceFactor = 385 * G_TO_N; 

    // ë°ì´í„° ì €ì¥ì†Œ
    let logData = [];
    let loggingInterval = null;
    let isTouching = false;
    let startTime = 0;

    // ì¸¡ì • ìƒíƒœ ë³€ìˆ˜
    let currentRawForce = 0;
    let currentForceN = 0;
    let startX = 0, startY = 0;
    let currentX = 0, currentY = 0;
    let isDragging = false;

    // === ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===

    // 1. í„°ì¹˜ ì‹œì‘
    touchArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (e.touches.length > 0) {
            resetSession();
            isTouching = true;
            touchArea.classList.add('active');
            touchArea.innerHTML = "<div style='font-size:3rem;'>âœŠ</div><div>ì¸¡ì • ì¤‘...</div>"; // ì•„ì´ì½˜ ë³€ê²½

            // ë“œë˜ê·¸ ê¸°ì¤€ì 
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            
            // ë¡œê¹… ì‹œì‘
            startTime = Date.now();
            startLogging();
        }
    }, { passive: false });

    // 2. í„°ì¹˜ ì´ë™ (ì••ë ¥ ë³€í™”)
    touchArea.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length > 0 && isTouching) {
            const touch = e.touches[0];

            // í˜ ê³„ì‚°
            currentRawForce = touch.force || touch.webkitForce || 0;
            currentForceN = (currentRawForce * forceFactor);
            
            // ë“œë˜ê·¸ ê°ì§€
            currentX = touch.clientX;
            currentY = touch.clientY;
            const dist = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
            isDragging = dist > 10; 

            // UI ì—…ë°ì´íŠ¸
            updateDisplay();
        }
    }, { passive: false });

    // 3. í„°ì¹˜ ì¢…ë£Œ
    touchArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopLogging();
        isTouching = false;
        
        currentRawForce = 0;
        currentForceN = 0;
        isDragging = false;
        updateDisplay();
        
        touchArea.classList.remove('active');
        touchArea.innerHTML = "<div style='font-size: 2rem;'>ğŸ‘‡</div><div style='margin-top:10px;'>ë‹¤ì‹œ ëˆ„ë¥´ë©´<br>ì‹œì‘í•©ë‹ˆë‹¤</div>";
        
        if (logData.length > 1) downloadBtn.disabled = false;
    });

    // === í•¨ìˆ˜ë“¤ ===

    function updateDisplay() {
        forceDisplay.innerText = currentForceN.toFixed(3);
        
        if (isDragging) {
            dragStatusDisplay.innerText = "ì´ë™ ì¤‘ âš ï¸";
            dragStatusDisplay.classList.add('warning');
        } else {
            dragStatusDisplay.innerText = "ì¸¡ì • ì¤‘";
            dragStatusDisplay.classList.remove('warning');
        }
    }

    function startLogging() {
        if (loggingInterval) clearInterval(loggingInterval);
        
        if(logData.length === 0) {
            logData.push(["Time(s)", "Force(N)", "Raw", "X", "Y", "Dragging"]);
        }

        loggingInterval = setInterval(() => {
            if (!isTouching) return;

            const now = Date.now();
            const timeSec = ((now - startTime) / 1000).toFixed(2);
            
            logData.push([
                timeSec,
                currentForceN.toFixed(4),
                currentRawForce.toFixed(4),
                currentX.toFixed(0),
                currentY.toFixed(0),
                isDragging ? "TRUE" : "FALSE"
            ]);

            logCountDisplay.innerText = `ë°ì´í„°: ${logData.length - 1}ê±´`;
        }, 50); 
    }

    function stopLogging() {
        if (loggingInterval) {
            clearInterval(loggingInterval);
            loggingInterval = null;
        }
    }

    function resetSession() {
        logData = [];
        downloadBtn.disabled = true;
        logCountDisplay.innerText = "ë°ì´í„°: 0ê±´";
        calibMsg.innerText = "";
    }

    // ë³´ì • í•¨ìˆ˜
    function calibrate() {
        const inputWeight = parseFloat(document.getElementById('calib-weight').value);
        if (!inputWeight || inputWeight <= 0) {
            alert("ë¬´ê²Œ(g)ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return;
        }
        if (currentRawForce <= 0.02) {
            alert("í™”ë©´ì„ ëˆ„ë¥¸ ìƒíƒœì—ì„œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."); return;
        }

        const targetN = inputWeight * G_TO_N;
        forceFactor = targetN / currentRawForce;
        
        calibMsg.innerText = `âœ… ë³´ì • ì™„ë£Œ (${inputWeight}g ê¸°ì¤€)`;
        forceDisplay.innerText = (currentRawForce * forceFactor).toFixed(3);
    }

    // ë‹¤ìš´ë¡œë“œ
    downloadBtn.addEventListener('click', () => {
        if (logData.length <= 1) return;
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        logData.forEach(row => csvContent += row.join(",") + "\r\n");
        
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        const date = new Date();
        link.setAttribute("download", `Force_${date.getHours()}${date.getMinutes()}${date.getSeconds()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
</script>

</body>
</html>