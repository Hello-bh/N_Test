<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Smart Auto-Capture Scale</title>
    <style>
        /* === ê¸°ë³¸ ì„¤ì • === */
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            text-align: center; color: #333;
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
        }

        .container {
            display: flex; flex-direction: column; height: 100%; padding: 10px; box-sizing: border-box; position: relative;
        }
        
        /* ìƒë‹¨ íŒ¨ë„ */
        .top-panel {
            flex: 0 0 auto; background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 10px; z-index: 5;
        }
        #current-force {
            font-size: 4em; font-weight: 900; color: #222; margin: 0; line-height: 1;
            font-variant-numeric: tabular-nums;
        }
        .status-text { font-size: 0.9em; color: #666; margin-top: 5px; display: flex; justify-content: space-between; padding: 0 10px;}

        /* === í„°ì¹˜ ì˜ì—­ ì»¨í…Œì´ë„ˆ === */
        #touch-container {
            flex: 1; width: 100%; position: relative;
            background-color: #e9ecef; border-radius: 15px; border: 4px dashed #adb5bd;
            overflow: hidden; margin-bottom: 10px; transition: background-color 0.2s;
        }
        #touch-container.active {
            background-color: #ffe3e3; border-color: #ff6b6b;
        }

        /* [Layer 1] ì‹œê°ì  ìš”ì†Œ */
        .visual-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1;
        }

        /* [Layer 2] íˆ¬ëª… ì„¼ì„œ ë§‰ */
        #sensor-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; background-color: transparent; touch-action: none;
        }

        /* í•˜ë‹¨ íŒ¨ë„ */
        .bottom-panel {
            flex: 0 0 auto; background: white; padding: 10px; border-radius: 15px; font-size: 0.9em; z-index: 5;
        }
        
        button { border: none; border-radius: 8px; padding: 12px; font-weight: bold; font-size: 15px; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-blue { background-color: #339af0; color: white; }
        .btn-green { background-color: #20c997; color: white; }
        .btn-gray { background-color: #e9ecef; color: #333; }
        button:disabled { background-color: #dee2e6; color: #adb5bd; cursor: not-allowed; }

        /* === ë³´ì • ìœ„ìë“œ ìŠ¤íƒ€ì¼ === */
        #calib-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 200;
            display: flex; flex-direction: column; 
            padding: 10px; box-sizing: border-box;
        }

        .grid-container {
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            gap: 2px; flex: 1; width: 100%; margin: 10px 0;
        }

        .grid-cell {
            background: #f1f3f5; border: 1px solid #dee2e6; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; color: #adb5bd; font-weight: bold;
        }
        .grid-cell.target { background: #ffe3e3; border: 2px solid red; color: red; }
        .grid-cell.done { background: #d3f9d8; border: 1px solid #20c997; color: #0ca678; }

        /* ìë™ ì¸¡ì • ì§„í–‰ë°” */
        #auto-progress-container {
            width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 10px; overflow: hidden; display: none;
        }
        #auto-progress-bar {
            width: 0%; height: 100%; background: #20c997; transition: width 0.1s linear;
        }

        #drag-status.warning { color: red; font-weight: bold; }
        input[type=number] { padding: 10px; width: 100px; text-align: center; border: 1px solid #ccc; border-radius: 8px; font-size: 1.2em; margin-bottom: 20px;}
        
        /* ë²„íŠ¼ í´ë¦­ ë¬¸ì œ í•´ê²°ìš© ìŠ¤íƒ€ì¼ */
        #btn-next-step {
            position: relative; z-index: 9999; /* ì„¼ì„œë³´ë‹¤ ë¬´ì¡°ê±´ ìœ„ì— */
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-panel">
        <div class="status-text">
            <span>Force (N)</span>
            <span id="drag-status">ëŒ€ê¸°ì¤‘</span>
        </div>
        <h1 id="current-force">0.000</h1>
    </div>

    <div id="touch-container">
        <div class="visual-layer" id="visual-content">
            <div style="font-size: 3rem;">ğŸ‘‡</div>
            <div style="margin-top:10px; font-size:1.2rem; font-weight:bold; color:#868e96;">
                ì´ ì˜ì—­ ì „ì²´ê°€<br>ì €ìš¸ì…ë‹ˆë‹¤
            </div>
            <div style="position:absolute; width:100%; height:33.3%; top:33.3%; border-top:1px dashed #ccc; border-bottom:1px dashed #ccc;"></div>
            <div style="position:absolute; width:33.3%; height:100%; left:33.3%; border-left:1px dashed #ccc; border-right:1px dashed #ccc;"></div>
        </div>
        <div id="sensor-layer"></div>
    </div>

    <div class="bottom-panel">
        <button class="btn-gray" onclick="startCalibrationMode()">âš™ï¸ 3x3 ë³´ì • ëª¨ë“œ</button>
        <div style="margin-top:10px; font-size: 0.8em; color: #555;" id="log-count">ë°ì´í„°: 0ê±´</div>
        <button id="download-btn" class="btn-blue" style="margin-top:5px;" disabled>ğŸ“¥ ì—‘ì…€(CSV) ì €ì¥</button>
    </div>

    <div id="calib-overlay">
        <div id="calib-start" style="margin: auto; text-align: center; width: 100%;">
            <h2>ğŸ“ ìŠ¤ë§ˆíŠ¸ ë³´ì •</h2>
            <p style="color:#666;">ê¸°ì¤€ ë¬¼ì²´ ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="number" id="wizard-weight" value="100" placeholder="g"> <span style="font-size:1.2em; font-weight:bold;">g</span><br>
            <button class="btn-green" onclick="startWizard()" style="padding: 15px; font-size: 1.1em;">ì¸¡ì • ì‹œì‘í•˜ê¸°</button><br><br>
            <button class="btn-gray" onclick="closeCalibration()">ê±´ë„ˆë›°ê¸°</button>
        </div>

        <div id="calib-process" style="display:none; flex-direction:column; height:100%; width:100%;">
            <div style="text-align:center; padding:10px;">
                <h3 id="step-title" style="margin:0;">Step 1 / 9</h3>
                <p id="step-desc" style="margin:5px 0; color:#e03131; font-weight:bold; font-size:0.9em;">
                    ë¹¨ê°„ ë°•ìŠ¤ë¥¼ ê¾¹ ëˆ„ë¥´ê³  ê¸°ë‹¤ë¦¬ì„¸ìš”
                </p>
                <div id="auto-progress-container">
                    <div id="auto-progress-bar"></div>
                </div>
            </div>
            
            <div style="flex:1; position:relative;">
                <div class="grid-container" id="grid-visual" style="height:100%; margin:0;"></div>
                <div id="calib-sensor" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:201; touch-action:none;"></div>
            </div>
            
            <div style="padding:10px; text-align:center;">
                <div style="font-weight:bold; margin-bottom:10px;">Raw Value: <span id="calib-raw" style="color:#228be6;">0.00</span></div>
                <button class="btn-green" id="btn-next-step" style="padding:15px;">ìˆ˜ë™ ì €ì¥ (ë˜ëŠ” ìë™ ëŒ€ê¸°)</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === DOM ===
    const touchContainer = document.getElementById('touch-container');
    const sensorLayer = document.getElementById('sensor-layer'); 
    const calibSensor = document.getElementById('calib-sensor');
    const forceDisplay = document.getElementById('current-force');
    const dragStatusDisplay = document.getElementById('drag-status');
    const logCountDisplay = document.getElementById('log-count');
    const downloadBtn = document.getElementById('download-btn');
    const calibOverlay = document.getElementById('calib-overlay');
    const nextStepBtn = document.getElementById('btn-next-step');
    const progressBar = document.getElementById('auto-progress-bar');
    const progressContainer = document.getElementById('auto-progress-container');
    
    const G_TO_N = 0.00980665; 

    // ì¸¡ì • ë³€ìˆ˜
    let logData = [];
    let loggingInterval = null;
    let isTouching = false;
    let startTime = 0;
    let currentRawForce = 0;
    let currentForceN = 0;
    let currentX = 0, currentY = 0;
    let lastLogX = 0, lastLogY = 0;
    let isDragging = false;

    // ë³´ì • ë³€ìˆ˜
    let targetWeightGram = 100;
    let isCalibrated = false;
    let defaultFactor = 385 * G_TO_N;
    let calibPoints = Array(9).fill(0).map(() => ({ raw: 0, factor: 0 }));
    let currentStep = 0;

    // ìë™ ì¸¡ì • íƒ€ì´ë¨¸ ë³€ìˆ˜
    let autoCaptureTimer = null;
    let holdDuration = 0; // ëˆ„ë¥´ê³  ìˆëŠ” ì‹œê°„ (ms)
    const REQUIRED_HOLD_MS = 1500; // 1.5ì´ˆ ìœ ì§€ ì‹œ ìë™ ì €ì¥

    const GRID_X = [0.166, 0.5, 0.833];
    const GRID_Y = [0.166, 0.5, 0.833];

    // === ì´ˆê¸°í™” ===
    createGridVisuals();
    startCalibrationMode(); 

    // === ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===
    sensorLayer.addEventListener('touchstart', onTouchStart, { passive: false });
    sensorLayer.addEventListener('touchmove', onTouchMove, { passive: false });
    sensorLayer.addEventListener('touchend', onTouchEnd, { passive: false });

    // ë³´ì • ì„¼ì„œ (ìë™ ì¸¡ì • ë¡œì§ í¬í•¨)
    calibSensor.addEventListener('touchstart', onCalibTouchStart, { passive: false });
    calibSensor.addEventListener('touchmove', onCalibTouchMove, { passive: false });
    calibSensor.addEventListener('touchend', onCalibTouchEnd, { passive: false });

    // ë²„íŠ¼ í´ë¦­ (ìˆ˜ë™)
    nextStepBtn.addEventListener('click', () => {
        captureCurrentStep(true); // ìˆ˜ë™ í´ë¦­ ê°•ì œ ì €ì¥
    });

    // === ë©”ì¸ ì¸¡ì • ë¡œì§ ===
    function onTouchStart(e) {
        e.preventDefault();
        if (e.touches.length > 0) {
            resetSession();
            isTouching = true;
            touchContainer.classList.add('active');
            document.getElementById('visual-content').style.visibility = 'hidden';

            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            lastLogX = currentX; lastLogY = currentY;
            isDragging = false;
            
            startTime = Date.now();
            startLogging();
        }
    }

    function onTouchMove(e) {
        e.preventDefault();
        if (e.touches.length > 0) {
            const touch = e.touches[0];
            currentRawForce = touch.force || touch.webkitForce || 0;
            currentX = touch.clientX;
            currentY = touch.clientY;
            currentForceN = calculateBilinearForce(currentRawForce, currentX, currentY);
            forceDisplay.innerText = currentForceN.toFixed(3);
        }
    }

    function onTouchEnd(e) {
        e.preventDefault();
        stopLogging();
        isTouching = false;
        currentRawForce = 0; currentForceN = 0;
        forceDisplay.innerText = "0.000";
        dragStatusDisplay.innerText = "ëŒ€ê¸°ì¤‘";
        dragStatusDisplay.classList.remove('warning');
        touchContainer.classList.remove('active');
        document.getElementById('visual-content').style.visibility = 'visible';
        if (logData.length > 1) downloadBtn.disabled = false;
    }

    // === ë³´ì • ë° ìë™ ì¸¡ì • ë¡œì§ (í•µì‹¬) ===
    function onCalibTouchStart(e) {
        e.preventDefault();
        holdDuration = 0;
        updateProgress(0);
        progressContainer.style.display = 'block';
        
        // íƒ€ì´ë¨¸ ì‹œì‘
        if(autoCaptureTimer) clearInterval(autoCaptureTimer);
        autoCaptureTimer = setInterval(checkAutoCapture, 100); // 0.1ì´ˆë§ˆë‹¤ ì²´í¬
    }

    function onCalibTouchMove(e) {
        e.preventDefault();
        if (e.touches.length > 0) {
            const touch = e.touches[0];
            currentRawForce = touch.force || touch.webkitForce || 0;
            updateCalibDisplay();
        }
    }

    function onCalibTouchEnd(e) {
        e.preventDefault();
        currentRawForce = 0;
        updateCalibDisplay();
        
        // í„°ì¹˜ ë–¼ë©´ íƒ€ì´ë¨¸ ë° ê²Œì´ì§€ ì´ˆê¸°í™”
        resetAutoCapture();
    }

    function checkAutoCapture() {
        // í˜ì´ ì¶©ë¶„í•  ë•Œë§Œ ê²Œì´ì§€ ì¦ê°€
        if (currentRawForce > 0.02) {
            holdDuration += 100;
            const percent = Math.min(100, (holdDuration / REQUIRED_HOLD_MS) * 100);
            updateProgress(percent);

            if (holdDuration >= REQUIRED_HOLD_MS) {
                // ì‹œê°„ ì¶©ì¡± ì‹œ ìë™ ì €ì¥
                resetAutoCapture();
                captureCurrentStep(false); // ìë™ ì €ì¥ í˜¸ì¶œ
            }
        } else {
            // í˜ ë¹ ì§€ë©´ ë¦¬ì…‹
            holdDuration = 0;
            updateProgress(0);
        }
    }

    function resetAutoCapture() {
        if(autoCaptureTimer) clearInterval(autoCaptureTimer);
        autoCaptureTimer = null;
        holdDuration = 0;
        updateProgress(0);
    }

    function updateProgress(percent) {
        progressBar.style.width = percent + '%';
        if(percent > 0) {
            document.getElementById('step-desc').innerText = percent >= 100 ? "ì €ì¥ ì¤‘..." : "ì¸¡ì • ì¤‘... ìœ ì§€í•˜ì„¸ìš”";
            document.getElementById('step-desc').style.color = "#20c997";
        } else {
            document.getElementById('step-desc').innerText = "ë¹¨ê°„ ë°•ìŠ¤ë¥¼ ê¾¹ ëˆ„ë¥´ê³  ê¸°ë‹¤ë¦¬ì„¸ìš”";
            document.getElementById('step-desc').style.color = "#e03131";
        }
    }

    function updateCalibDisplay() {
        const el = document.getElementById('calib-raw');
        if(el) el.innerText = currentRawForce.toFixed(3);
    }

    function calculateBilinearForce(raw, xPx, yPx) {
        if (!isCalibrated) return raw * defaultFactor;
        const rect = sensorLayer.getBoundingClientRect();
        let nx = (xPx - rect.left) / rect.width;
        let ny = (yPx - rect.top) / rect.height;
        nx = Math.max(0, Math.min(1, nx)); ny = Math.max(0, Math.min(1, ny));
        let col = (nx < 0.5) ? 0 : 1; let row = (ny < 0.5) ? 0 : 1;
        let x1 = GRID_X[col], x2 = GRID_X[col+1];
        let y1 = GRID_Y[row], y2 = GRID_Y[row+1];
        let u = (nx - x1) / (x2 - x1); let v = (ny - y1) / (y2 - y1);
        u = Math.max(0, Math.min(1, u)); v = Math.max(0, Math.min(1, v));
        const p1 = (row * 3) + col; const p2 = (row * 3) + (col + 1);
        const p3 = ((row + 1) * 3) + col; const p4 = ((row + 1) * 3) + (col + 1);
        const f1 = calibPoints[p1].factor; const f2 = calibPoints[p2].factor;
        const f3 = calibPoints[p3].factor; const f4 = calibPoints[p4].factor;
        return raw * ((1-u)*(1-v)*f1 + u*(1-v)*f2 + (1-u)*v*f3 + u*v*f4);
    }

    function createGridVisuals() {
        const container = document.getElementById('grid-visual');
        container.innerHTML = '';
        const labels = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];
        for(let i=0; i<9; i++) {
            const div = document.createElement('div');
            div.className = 'grid-cell';
            div.id = `gc-${i}`;
            div.innerHTML = labels[i];
            container.appendChild(div);
        }
    }

    function startCalibrationMode() {
        calibOverlay.style.display = 'flex';
        document.getElementById('calib-start').style.display = 'block';
        document.getElementById('calib-process').style.display = 'none';
        currentStep = 0;
    }

    function startWizard() {
        const w = parseFloat(document.getElementById('wizard-weight').value);
        if(!w || w<=0) { alert("ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
        targetWeightGram = w;
        document.getElementById('calib-start').style.display = 'none';
        document.getElementById('calib-process').style.display = 'flex';
        updateWizardUI();
    }

    function updateWizardUI() {
        document.getElementById('step-title').innerText = `Step ${currentStep+1} / 9`;
        for(let i=0; i<9; i++) {
            const cell = document.getElementById(`gc-${i}`);
            cell.classList.remove('target');
            if(i < currentStep) cell.classList.add('done');
        }
        if(currentStep < 9) document.getElementById(`gc-${currentStep}`).classList.add('target');
    }

    function captureCurrentStep(isManual = false) {
        if (currentRawForce <= 0.02) {
            if(isManual) alert("í˜ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¬¼ì²´ë¥¼ ëˆ„ë¥´ê³  ê³„ì‹ ê°€ìš”?");
            return;
        }
        
        // ë°ì´í„° ì €ì¥
        calibPoints[currentStep].raw = currentRawForce;
        currentStep++;
        
        // UI ê¹œë¹¡ì„ í”¼ë“œë°±
        document.body.style.backgroundColor = "#d3f9d8";
        setTimeout(() => document.body.style.backgroundColor = "#f8f9fa", 100);

        if(currentStep < 9) {
            updateWizardUI();
        } else {
            finishCalibration();
        }
    }

    function finishCalibration() {
        const targetN = targetWeightGram * G_TO_N;
        calibPoints.forEach(p => p.factor = targetN / p.raw);
        isCalibrated = true;
        closeCalibration();
        alert("ë³´ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ììœ ë¡­ê²Œ ì¸¡ì •í•˜ì„¸ìš”.");
    }

    function closeCalibration() {
        calibOverlay.style.display = 'none';
    }

    // === CSV ì €ì¥ ===
    function startLogging() {
        if (loggingInterval) clearInterval(loggingInterval);
        if(logData.length === 0) logData.push(["Time(s)", "Force(N)", "Raw", "X", "Y", "Moving"]);
        
        loggingInterval = setInterval(() => {
            if (!isTouching) return;
            const dist = Math.sqrt(Math.pow(currentX - lastLogX, 2) + Math.pow(currentY - lastLogY, 2));
            isDragging = dist > 2;
            lastLogX = currentX; lastLogY = currentY;

            if(isDragging) {
                dragStatusDisplay.innerText = "ì´ë™ ì¤‘ âš ï¸";
                dragStatusDisplay.classList.add('warning');
            } else {
                dragStatusDisplay.innerText = "ì•ˆì •";
                dragStatusDisplay.classList.remove('warning');
            }

            const timeSec = ((Date.now() - startTime) / 1000).toFixed(2);
            logData.push([timeSec, currentForceN.toFixed(4), currentRawForce.toFixed(4), currentX.toFixed(0), currentY.toFixed(0), isDragging?"TRUE":"FALSE"]);
            logCountDisplay.innerText = `ë°ì´í„°: ${logData.length - 1}ê±´`;
        }, 50);
    }
    
    function stopLogging() {
        if (loggingInterval) clearInterval(loggingInterval);
        loggingInterval = null;
    }
    
    function resetSession() {
        logData = [];
        downloadBtn.disabled = true;
        logCountDisplay.innerText = "ë°ì´í„°: 0ê±´";
    }

    downloadBtn.addEventListener('click', () => {
        if (logData.length <= 1) return;
        let csv = "data:text/csv;charset=utf-8,\uFEFF";
        logData.forEach(r => csv += r.join(",") + "\r\n");
        const a = document.createElement("a");
        a.href = encodeURI(csv);
        a.download = `Force3x3_${Date.now()}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });
</script>

</body>
</html>
